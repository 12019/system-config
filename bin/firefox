#!/bin/bash

function push-url() {
    ring=$1
    shift
    if test "$1" = -new-tab; then
        shift
    fi

    (echo "$@"; cat "$ring" 2>/dev/null)|
    uniq-even-non-ajacent |head -n 50 > "$ring.$$"
    mv "$ring".$$ "$ring"
}

function pop-url() {
    ring=$1
    shift

    perl -ne 'BEGIN{$url = "'"$1"'"} print if m!\Q$url\E!..0' "$ring" | perl -ne 'print if 2..0' > "$ring".$$
    mv "$ring".$$ "$ring"
}

export -f push-url pop-url

if test "$1" = -new-tab; then
    push-url ~/.logs/firefox-tab-ring "$(get-firefox-tab-url)"
fi

function do_it() {
    (
        export ring1=$1
        export ring2=$2
        flock 9
        push-url $ring2 "$(get-firefox-tab-url)"
        cat $ring1 | xargs -d \\n \
            bash -c '
                for x in "$@"; do
                    if test "$(get-firefox-tab-url)" = "$x"; then
                        push-url $ring2 "$x"
                        echo "will skip $x"
                        continue;
                    fi
                    if $(firefox-search-for-tab "\Q$x\E"); then
                       echo "will open $x"
                       push-url $ring2 "$x"
                       pop-url $ring1 "$x"
                       exit
                   fi
               done
               echo will now empty $ring1
               echo -n > $ring1
           ' true
    ) 9<~/.bashrc
}

if test "$1" = pop; then
    do_it ~/.logs/firefox-tab-ring ~/.logs/firefox-tab-ring.pop
    exit
fi

if test "$1" = push; then
    if test $# -gt 1; then
        shift
        push-url ~/.logs/firefox-tab-ring "$@"
    else
        do_it ~/.logs/firefox-tab-ring.pop ~/.logs/firefox-tab-ring
    fi
    exit

fi

if test $# = 1; then
    set -- -new-tab "$@"
fi

if test "$1" = -current-tab; then
    shift
fi

if test -x ~/external/firefox/firefox; then
   ~/external/firefox/firefox "$@";
fi
