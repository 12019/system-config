#!/bin/bash

set -e
function die() {
    echo Error: "$@"
    exit -1
}

function douban-misc() {
    emacsclient -e '
        (let* ((song-info (elt douban-music-song-list douban-music-current-song))
               (channel (aget douban-music-channels douban-music-current-channel))
               (album (aget song-info '\''albumtitle))
               (title (aget song-info '\''title))
               (picture (aget song-info '\''picture))
               (artist (aget song-info '\''artist))
               (url (aget song-info '\''url)))
          (shell-command-to-string
            (format "#set -x;
  export channel=%s;
  export artist=%s;
  export album=%s;
  export title=%s;
  export picture_url=%s;
  export mp3_url=%s
  export song=~/Music/like/$artist/$album/$title.mp3
  export icon=~/Music/like/$artist/$album/$title.png
  export douban_action='$douban_action'
  douban misc"
                (shell-quote-argument (replace-regexp-in-string "/" "%" channel))
                (shell-quote-argument (replace-regexp-in-string "/" "%" artist))
                (shell-quote-argument (replace-regexp-in-string "/" "%" album))
                (shell-quote-argument (replace-regexp-in-string "/" "%" title))
                (shell-quote-argument picture)
                (shell-quote-argument url))))'
}

export douban_action=${douban_action:-unknown}
case "$1" in
    like)
        true
        ;;
    misc)
        shift
        (
            set -x
            case $douban_action in
                bagua)
                    search-google "$artist"
                    search-google "$artist" "$title"
                    ;;
                info)

                    if test -e ~/.do-not-disturb.bak; then
                        mv ~/.do-not-disturb.bak ~/.do-not-disturb
                    fi
                    bhj-notify -i "$icon" DoubanMusic.el \
                        "$(
                                echo channel: $channel
                                echo
                                echo album: $album
                                echo title: $title
                                echo artist: $artist
                         )"
                    ;;
                start-play-hook)
                    downloading=false
                    if test ! -e "$song" -o ! -e "$icon" ; then
                        downloading=true
                        (
                            mkdir -p "$(dirname "$song")"
                            wget "$mp3_url" -O "$song".$$ && mv "$song".$$ "$song"
                            wget "$picture_url" -O "$icon".$$ && mv "$icon".$$ "$icon"
                            if test ! -e ~/.do-not-disturb; then
                                douban_action=info douban misc
                            fi
                        )&
                    fi

                    if test -e "$song" -a -e ~/.douban/download-or-next -a $downloading != true; then
                        douban next
                    fi
                    ;;
            esac
        ) >>~/.logs/douban-misc.log 2>&1 &
        ;;
    ba) # bagua
        douban_action=bagua
        douban-misc
        ;;
    start-play-hook)
        douban_action=start-play-hook
        douban-misc
        ;;
    info)
        douban_action=info
        douban-misc
        ;;
    lyrics)
        shift
        if test $# != 0; then
            url=$(search-lyrics "$@")
        else
            url=$(search-lyrics "$(info|perl -ne 'if (m/^artist|^title/) {s/.*?://; print}')")
        fi
        douban info
        host=$(echo $url|perl -npe 's!((?:.*://)?.*?)/.*!$1!')
        firefox-open-url-pattern $host "$url"
        ;;
    back)
        emacsclient -e '(douban-music-seek-backward '$2')'
        ;;
    forth)
        emacsclient -e '(douban-music-seek-forward '$2')'
        ;;
    replay)
        if test -e ~/.do-not-disturb; then
            mv ~/.do-not-disturb ~/.do-not-disturb.bak
        fi
        emacsclient -e '(progn
                          (setq douban-music-should-replay t)
                          (douban-music-play-next-refresh))'
        ;;
    next)
        if test -e ~/.do-not-disturb; then
            mv ~/.do-not-disturb ~/.do-not-disturb.bak
        fi
        emacsclient -e '(douban-music-play-next-refresh)'
        ;;
    prev)
        if test -e ~/.do-not-disturb; then
            mv ~/.do-not-disturb ~/.do-not-disturb.bak
        fi
        emacsclient -e '(douban-music-play-previous)'
        ;;
    nchan)
        if test -e ~/.do-not-disturb; then
            mv ~/.do-not-disturb ~/.do-not-disturb.bak
        fi
        emacsclient -e '(douban-music-next-channel)'
        ;;
    pchan)
        if test -e ~/.do-not-disturb; then
            mv ~/.do-not-disturb ~/.do-not-disturb.bak
        fi
        emacsclient -e '(douban-music-prev-channel)'
        ;;
    pause)
        emacsclient -e '(douban-music-pause/resume)'
        ;;
    *)
        die "not a douban.el command"
        ;;
esac
